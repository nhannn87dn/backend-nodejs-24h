# Woking with MongoDB

## üíõ Preparing MongoDB 


![mongodb](https://images.viblo.asia/29322fc4-a1b0-4416-9dce-0d4b34843cf6.png)

- MongoDB l√† m·ªôt h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu m√£ ngu·ªìn m·ªü, l√† CSDL thu·ªôc NoSql v√† ƒë∆∞·ª£c h√†ng tri·ªáu ng∆∞·ªùi s·ª≠ d·ª•ng.
- MongoDB l√† m·ªôt database h∆∞·ªõng t√†i li·ªáu (document), c√°c d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ trong document ki·ªÉu JSON thay v√¨ d·∫°ng b·∫£ng nh∆∞ CSDL quan h·ªá n√™n truy v·∫•n s·∫Ω r·∫•t nhanh.
- V·ªõi CSDL quan h·ªá ch√∫ng ta c√≥ kh√°i ni·ªám b·∫£ng, c√°c c∆° s·ªü d·ªØ li·ªáu quan h·ªá (nh∆∞ MySQL hay SQL Server...) s·ª≠ d·ª•ng c√°c b·∫£ng ƒë·ªÉ l∆∞u d·ªØ li·ªáu th√¨ v·ªõi MongoDB ch√∫ng ta s·∫Ω d√πng kh√°i ni·ªám l√† collection thay v√¨ b·∫£ng
- So v·ªõi RDBMS th√¨ trong MongoDB collection ·ª©ng v·ªõi table, c√≤n document s·∫Ω ·ª©ng v·ªõi row , MongoDB s·∫Ω d√πng c√°c document thay cho row trong RDBMS.
- C√°c collection trong MongoDB ƒë∆∞·ª£c c·∫•u tr√∫c r·∫•t linh ho·∫°t, cho ph√©p c√°c d·ªØ li·ªáu l∆∞u tr·ªØ kh√¥ng c·∫ßn tu√¢n theo m·ªôt c·∫•u tr√∫c nh·∫•t ƒë·ªãnh.
- Th√¥ng tin li√™n quan ƒë∆∞·ª£c l∆∞u tr·ªØ c√πng nhau ƒë·ªÉ truy c·∫≠p truy v·∫•n nhanh th√¥ng qua ng√¥n ng·ªØ truy v·∫•n MongoDB

###  ∆Øu ƒëi·ªÉm c·ªßa mongoDB

- D·ªØ li·ªáu l∆∞u tr·ªØ phi c·∫•u tr√∫c, kh√¥ng c√≥ t√≠nh r√†ng bu·ªôc, to√†n v·∫πn n√™n t√≠nh s·∫µn s√†ng cao, hi·ªáu su·∫•t l·ªõn v√† d·ªÖ d√†ng m·ªü r·ªông l∆∞u tr·ªØ.
- D·ªØ li·ªáu ƒë∆∞·ª£c caching (ghi ƒë·ªám) l√™n RAM, h·∫°n ch·∫ø truy c·∫≠p v√†o ·ªï c·ª©ng n√™n t·ªëc ƒë·ªô ƒë·ªçc v√† ghi cao

###  Nh∆∞·ª£c ƒëi·ªÉm c·ªßa MongoDB

- Kh√¥ng ·ª©ng d·ª•ng ƒë∆∞·ª£c cho c√°c m√¥ h√¨nh giao d·ªãch n√†o c√≥ y√™u c·∫ßu ƒë·ªô ch√≠nh x√°c cao do kh√¥ng c√≥ r√†ng bu·ªôc.
- Kh√¥ng c√≥ c∆° ch·∫ø transaction (giao d·ªãch) ƒë·ªÉ ph·ª•c v·ª• c√°c ·ª©ng d·ª•ng ng√¢n h√†ng.
- D·ªØ li·ªáu l·∫•y RAM l√†m tr·ªçng t√¢m ho·∫°t ƒë·ªông v√¨ v·∫≠y khi ho·∫°t ƒë·ªông y√™u c·∫ßu m·ªôt b·ªô nh·ªõ RAM l·ªõn.
- M·ªçi thay ƒë·ªïi v·ªÅ d·ªØ li·ªáu m·∫∑c ƒë·ªãnh ƒë·ªÅu ch∆∞a ƒë∆∞·ª£c ghi xu·ªëng ·ªï c·ª©ng ngay l·∫≠p t·ª©c v√¨ v·∫≠y kh·∫£ nƒÉng b·ªã m·∫•t d·ªØ li·ªáu t·ª´ nguy√™n nh√¢n m·∫•t ƒëi·ªán ƒë·ªôt xu·∫•t l√† r·∫•t cao.

###  Khi n√†o s·ª≠ d·ª•ng MongoDB?

- Qu·∫£n l√Ω v√† truy·ªÅn t·∫£i content ‚Äì Qu·∫£n l√Ω ƒëa d·∫°ng nhi·ªÅu product c·ªßa content ch·ªâ trong m·ªôt kho l∆∞u tr·ªØ data cho ph√©p thay ƒë·ªïi v√† ph·∫£n h·ªìi nhanh ch√≥ng m√† kh√¥ng ch·ªãu th√™m ph·ª©c t·∫°p th√™m t·ª´ h·ªá th·ªëng content.
- C·∫•u tr√∫c Mobile v√† Social ‚Äì MongoDB cung c·∫•p m·ªôt platform c√≥ s·∫µn, ph·∫£n x·∫° nhanh, v√† d·ªÖ m·ªü r·ªông cho ph√©p r·∫•t nhi·ªÅu kh·∫£ nƒÉng ƒë·ªôt ph√°, ph√¢n t√≠ch real-time, v√† h·ªó tr·ª£ to√†n c·∫ßu.
- Qu·∫£n l√Ω data kh√°ch h√†ng ‚Äì T·∫≠n d·ª•ng kh·∫£ nƒÉng query nhanh ch√≥ng cho ph√¢n t√≠ch real-time tr√™n c∆° s·ªü d·ªØ li·ªáu ng∆∞·ªùi d√πng c·ª±c l·ªõn v·ªõ c√°c m√¥ h√¨nh data ph·ª©c t·∫°p b·∫±ng c√°c schema linh ho·∫°t v√† t·ª± ƒë·ªông sharding cho m·ªü r·ªông chi·ªÅu ngang.

###  C√†i ƒë·∫∑t MongoDB

To be able to experiment with the code examples, you will need access to a MongoDB database.

You can download a free MongoDB database at https://www.mongodb.com.

> <https://www.mongodb.com/try/download/community>


Compass Tool: C√¥ng c·ª• ƒë·ªÉ qu·∫£n l√Ω MoogoDB b·∫±ng giao di·ªán ƒë·ªì h·ªça

> <https://www.mongodb.com/products/compass>

Extension for VS Code:

> <https://www.mongodb.com/products/vs-code>

PaaS: Get started right away with a MongoDB cloud service at https://www.mongodb.com/cloud/atlas.

## üíõ  Database Relationships

Tr∆∞·ªõc khi ƒëi t√¨m hi·ªÉu **Data Model Design** ch√∫ng ta c·∫ßn bi·∫øt m·ªëi quan h·ªá trong CSDL

#### üî∂ One to One - M·ªôt m·ªôt

Ki·ªÉu quan h·ªá m·ªôt m·ªôt (one-to-one relationship) l√† m·ªôt ki·ªÉu quan h·ªá gi·ªØa hai th·ª±c th·ªÉ (entities) trong c∆° s·ªü d·ªØ li·ªáu, trong ƒë√≥ `m·ªói` th·ª±c th·ªÉ c·ªßa m·ªôt b·∫£ng d·ªØ li·ªáu ch·ªâ li√™n k·∫øt v·ªõi `M·ªòT` th·ª±c th·ªÉ duy nh·∫•t c·ªßa b·∫£ng d·ªØ li·ªáu kh√°c. N√≥i c√°ch kh√°c, m·ªói th·ª±c th·ªÉ c·ªßa b·∫£ng A ch·ªâ ƒë∆∞·ª£c li√™n k·∫øt v·ªõi `M·ªòT` th·ª±c th·ªÉ duy nh·∫•t c·ªßa b·∫£ng B, v√† ng∆∞·ª£c l·∫°i.

V√≠ d·ª•, trong m·ªôt c∆° s·ªü d·ªØ li·ªáu qu·∫£n l√Ω nh√¢n vi√™n, m·ªói nh√¢n vi√™n ch·ªâ c√≥ m·ªôt t√†i kho·∫£n l∆∞∆°ng duy nh·∫•t v√† m·ªói t√†i kho·∫£n l∆∞∆°ng ch·ªâ thu·ªôc v·ªÅ m·ªôt nh√¢n vi√™n duy nh·∫•t. ƒê√¢y l√† m·ªôt m·ªëi quan h·ªá m·ªôt-m·ªôt gi·ªØa b·∫£ng "Employees" v√† b·∫£ng "SalaryAccounts".

V√≠ d·ª• QL Sinh vi√™n: M·ªói sinh vi√™n ch·ªâ c√≥ m·ªôt h·ªì s∆° sinh vi√™n duy nh·∫•t v√† m·ªói h·ªì s∆° sinh vi√™n ch·ªâ thu·ªôc v·ªÅ m·ªôt sinh vi√™n duy nh·∫•t. ƒê√¢y l√† m·ªôt m·ªëi quan h·ªá m·ªôt-m·ªôt gi·ªØa b·∫£ng "Students" v√† b·∫£ng "StudentProfiles".

#### üî∂ One to Many - M·ªôt nhi·ªÅu

Ki·ªÉu quan h·ªá m·ªôt nhi·ªÅu (one-to-many relationship) l√† m·ªôt ki·ªÉu quan h·ªá gi·ªØa hai th·ª±c th·ªÉ trong c∆° s·ªü d·ªØ li·ªáu, trong ƒë√≥ `M·ªòT` th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu c√≥ th·ªÉ ƒë∆∞·ª£c li√™n k·∫øt v·ªõi `NHI·ªÄU` th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu kh√°c, nh∆∞ng m·ªói th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu kh√°c l·∫°i ch·ªâ li√™n k·∫øt v·ªõi m·ªôt th·ª±c th·ªÉ duy nh·∫•t c·ªßa b·∫£ng d·ªØ li·ªáu ƒë·∫ßu ti√™n.

V√≠ d·ª•, trong m·ªôt c∆° s·ªü d·ªØ li·ªáu qu·∫£n l√Ω kh√°ch s·∫°n, m·ªôt kh√°ch s·∫°n c√≥ th·ªÉ c√≥ nhi·ªÅu ph√≤ng, nh∆∞ng m·ªói ph√≤ng ch·ªâ thu·ªôc v·ªÅ m·ªôt kh√°ch s·∫°n duy nh·∫•t. ƒê√¢y l√† m·ªôt m·ªëi quan h·ªá m·ªôt nhi·ªÅu gi·ªØa b·∫£ng "Hotels" v√† b·∫£ng "Rooms".

#### üî∂ Many to Many - Nhi·ªÅu nhi·ªÅu

Ki·ªÉu quan h·ªá nhi·ªÅu nhi·ªÅu (many-to-many relationship) l√† m·ªôt ki·ªÉu quan h·ªá gi·ªØa hai b·∫£ng d·ªØ li·ªáu trong c∆° s·ªü d·ªØ li·ªáu, trong ƒë√≥ m·ªói th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu A c√≥ th·ªÉ li√™n k·∫øt v·ªõi nhi·ªÅu th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu B, v√† m·ªói th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu B c≈©ng c√≥ th·ªÉ li√™n k·∫øt v·ªõi nhi·ªÅu th·ª±c th·ªÉ c·ªßa b·∫£ng d·ªØ li·ªáu A.

V√≠ d·ª•, trong m·ªôt c∆° s·ªü d·ªØ li·ªáu qu·∫£n l√Ω ƒë∆°n h√†ng tr·ª±c tuy·∫øn, m·ªôt ƒë∆°n h√†ng c√≥ th·ªÉ c√≥ nhi·ªÅu s·∫£n ph·∫©m, v√† m·ªôt s·∫£n ph·∫©m c≈©ng c√≥ th·ªÉ xu·∫•t hi·ªán trong nhi·ªÅu ƒë∆°n h√†ng kh√°c nhau. ƒê√¢y l√† m·ªôt m·ªëi quan h·ªá nhi·ªÅu nhi·ªÅu gi·ªØa b·∫£ng "Orders" v√† b·∫£ng "Products".

## üíõ Subdocument and References

Trong NoSQL, kh√°i ni·ªám b·∫£ng ƒë∆∞·ª£c thay th·∫ø b·∫±ng kh√°i ni·ªám collection (t·∫≠p h·ª£p). M·ªôt collection trong NoSQL t∆∞∆°ng ƒë∆∞∆°ng v·ªõi m·ªôt b·∫£ng trong h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu quan h·ªá (RDBMS).

Trong NoSQL, document l√† m·ªôt ƒë·ªëi t∆∞·ª£ng c∆° b·∫£n trong c∆° s·ªü d·ªØ li·ªáu, t∆∞∆°ng ƒë∆∞∆°ng v·ªõi m·ªôt b·∫£n ghi trong h·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu quan h·ªá (RDBMS). M·ªôt document th∆∞·ªùng ƒë∆∞·ª£c bi·ªÉu di·ªÖn d∆∞·ªõi d·∫°ng c√°c c·∫∑p tr∆∞·ªùng (field) v√† gi√° tr·ªã t∆∞∆°ng ·ª©ng, v√† ƒë∆∞·ª£c l∆∞u tr·ªØ trong c√°c collection.

D·ª±a tr√™n m·ªëi quan h·ªá gi·ªØa CSDL, C·∫•u tr√∫c c·ªßa m·ªôt Document s·∫Ω ƒë∆∞·ª£c quy·∫øt ƒë·ªãnh b·ªüi 2 ki·ªÉu:

- Subdocuments (Hay c√≤n g·ªçi l√† embed)

![embed](img/embed-model.PNG)

M√¥ h√¨nh n√†y c√≥ t·ªëc ƒë·ªô truy v·∫•n nhanh h∆°n. Nh∆∞ng nh∆∞·ª£c ƒëi·ªÉm l√† Data ƒë√∫ng ch·∫•t NoSQL n√≥ kh√¥ng c√≥ m·ªëi t∆∞∆°ng quan d·ªØ li·ªáu g√¨ v·ªõi c√°c collection

- References

![embed](img/references-model.PNG)

M·∫∑c d√π mongoo ƒë∆∞·ª£c bi·∫øt ƒë·∫øn l√† NoSQL nh∆∞ng v·ªõi m√¥ h√¨nh n√†y th√¨ n√≥ c√≥ quan h·ªá.
T·ªëc ƒë·ªô truy v·∫•n trong m√¥ h√¨nh n√†y ch·∫≠m h∆°n ki·ªÉu `embed` v√¨ ph·∫£i tham chi·∫øu nhi·ªÅu collection ƒë·ªÉ l·∫•y d·ªØ li·ªáu.

Data Model Design: <https://www.mongodb.com/docs/manual/core/data-model-design/#data-model-design>

Data Model: <https://www.mongodb.com/docs/manual/applications/data-models/>

## üíõ Using MoongoDB

Chi ti·∫øt xem: <https://www.w3schools.com/nodejs/nodejs_mongodb.asp>

ƒê·ªÉ k·∫øt n·ªëi th∆∞ vi·ªán MongoDB v·ªõi Express.js, b·∫°n c·∫ßn th·ª±c hi·ªán c√°c b∆∞·ªõc sau:

1. C√†i ƒë·∫∑t MongoDB v√† th∆∞ vi·ªán MongoDB trong d·ª± √°n c·ªßa b·∫°n b·∫±ng c√°ch ch·∫°y l·ªánh sau trong terminal:

```bash
npm install mongodb
```
2. T·∫°i c√°c Routes

V√≠ d·ª•:


```js

const MongoClient = require('mongodb').MongoClient;
const url = "mongodb://localhost:27017/myStore";

// V√≠ d·ª• truy v·∫•n v√† l·∫•y d·ªØ li·ªáu t·ª´ MongoDB
router.get('/', (req, res, next) => {
     //K·∫øt n·ªëi ƒë·∫øn server MongoDB
     MongoClient.connect(url, function(err, db) {
      if (err) next(err);
      const dbo = db.db("myStore"); //ch·ªçn database
      dbo.collection("users").findOne({}, function(err, result) {
        if (err) next(err);
        res.json(result);
        db.close();//ƒë√≥ng k·∫øt n·ªëi
      });
    });
});
```

   Trong v√≠ d·ª• tr√™n, ch√∫ng ta ƒë√£ truy v·∫•n t·∫•t c·∫£ c√°c t√†i kho·∫£n ng∆∞·ªùi d√πng t·ª´ b·∫£ng `users` trong c∆° s·ªü d·ªØ li·ªáu v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON.



## üíõ Using Mongoose 


S·ª≠ d·ª•ng MongoDB qua th∆∞ vi·ªán Mongoose gi√∫p thao t√°c d·ªÖ h∆°n v·ªÅ m·∫∑t c√∫ ph√°p

```bash
npm install mongoose --save
yarn add mongoose --save
```


###  K·∫øt n·ªëi v·ªõi Database

ƒê∆∞a ƒëo·∫°n code n√†y v√†o server.js

```js
const mongoose = require('mongoose');

/// Start the server
const mongooseDbOptions = {
  autoIndex: true, // Don't build indexes
  maxPoolSize: 10, // Maintain up to 10 socket connections
  serverSelectionTimeoutMS: 5000, // Keep trying to send operations for 5 seconds
  socketTimeoutMS: 45000, // Close sockets after 45 seconds of inactivity
  family: 4, // Use IPv4, skip trying IPv6
  useNewUrlParser: true,
  useUnifiedTopology: true,
};
mongoose
  .connect('mongodb://127.0.0.1:27017/myapp', mongooseDbOptions)
  .then(() => {
    console.log('Connected to MongoDB');
    //should listen app here
  })
  .catch((err) => {
    console.error('Failed to Connect to MongoDB', err);
  });
```

Tips: B·∫°n c√≥ th·ªÉ ƒë∆∞a ƒëo·∫°n code kh·ªüi t·∫°o server c·ªßa Express v√†o ch·ªï `//should listen app here` ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng. Ph·∫£i k·∫øt n·ªëi server Mongoo th√†nh c√¥ng th√¨ m·ªõi kh·ªüi t·∫°o server NodeJs.

### Mongoose SchemaTypes

Tham kh·∫£o: <https://mongoosejs.com/docs/schematypes.html>

- String
- Number
- Date
- Buffer
- Boolean
- Mixed
- ObjectId
- Array
- Decimal128
- Map
- Schema

### T·∫°o m·ªôt Model Schema v·ªõi Mongoose

Doc: <https://mongoosejs.com/docs/guide.html#definition>

T·∫°o th∆∞ m·ª•c models, trong th∆∞ m·ª•c n√†y t·∫°o file user.model.js

C√∫ ph√°p

```js
new Schema({..}, options);

// or
const schema = new Schema({..});
schema.set(option, value);

```

Xem c√°c options ·ªü link sau: <https://mongoosejs.com/docs/guide.html#options>

V√≠ d·ª• v·ªÅ User Schema:

```js
const mongoose = require('mongoose');
const { Schema } = mongoose;

//T·∫°o Schema
const userSchema = new Schema(
  {
    name: String,
    email: String,
    password: String,
    role: String,
    isEmailVerified: Boolean,
  },
  { timestamps: true }
);
// T·∫°o Model User
const User = new mongoose.model('User', userSchema);
module.exports = User;
```


## üíõ MongoDB's ORM, Mongoose

Danh s√°ch c√°c ph∆∞∆°ng th·ª©c truy v·∫•n xem ·ªü link sau
Doc: <https://mongoosejs.com/docs/queries.html>

Thay v√¨ thao t√°c d·ªØ li·ªáu tr√™n file, ch√∫ng ta chuy·ªÉn qua k·∫øt n·ªëi v·ªõi Database v·ªõi Mongosee nh∆∞ sau:


### üî∂ Insert - Th√™m m·ªõi

B·∫°n s·ª≠a route user t·∫°i route th√™m M·ªõi User nh∆∞ sau:
l·∫°i nh∆∞ sau:

```js
//Th√™m v√†o tr√™n ƒë·∫ßu
const User = reuiqre('../models/user.model');


// Create a new user
// localhost:8686/api/v1/users
router.post('/users', authenticateToken, async (req, res,next) => {
  console.log('createUser',req.body);

  try {
    const payload = {
      name: req.body.name,
      email: req.body.email,
      password: req.body.password
    };
    // L∆∞u xu·ªëng database
    const user = await User.create(payload);
   
   res.status(200).json({
    codeStatus: 200,
    data: user
  });
    
  } catch (err) {
     next(err);
  }
});

```

### üî∂ Select - Truy v·∫•n d·ªØ li·ªáu

#### Select All

L·∫•y t·∫•t c·∫£ Users

```js
// Get all users
// localhost:8686/api/v1/users
router.get('/users', async (req, res) => {
  const users = User.find();
  res.status(200).json({
    codeStatus: 200,
    data: users
  });
});

```

#### Select by ID

L·∫•y th√¥ng tin m·ªôt User theo ID

```js

// Get a user by ID
// localhost:8686/api/v1/users/1
router.get('/users/:id', validateSchema(userValidation.getUserById), async (req, res,next) => {
  console.log('getUserById');
 
  try {
    const { id } = req.params;

    console.log('<<<< id>>>',id, typeof id)

    if (!id) {
      throw createError(400, 'Missing user ID');
    }

    const user = User.findById(parseInt(id));

    console.log('<<<< user >>>',user)

    if (!user) {
      throw createError(404, 'User not found');
    }

   res.status(200).json({
      codeStatus: 200,
      data: user
    });
  } catch (err) {
    next(err);
  }

});

```

### üî∂ Update

```js
// Update a user
// localhost:8686/api/v1/users/1
router.put('/users/:id', authenticateToken, async (req, res, next) => {
  console.log('upadteUserById');
  try {
    const { id } = req.params;

    
    /* Check exits user by id */
    const user = User.findById(parseInt(id));

    if (!user) {
      throw createError(404, `User not found with ID ${id}`);
    }

    const user = User.findByIdAndUpdate(parseInt(id), req.body, {
      new: true,
    })
    

   res.status(200).json({
      codeStatus: 200,
      data: user
    });

    
  } catch (err) {
     next(err);
  }
});

```

### üî∂ Delete

```js

// Delete a user
// localhost:8686/api/v1/users/1
router.delete('/users', authenticateToken, async (req, res, next) => {
  console.log('deleteUserById');

  try {
    const { id } = req.body;
    const user = User.findByIdAndDelete(id);

    if (!user) {
      throw createError(404, `User not found with ID ${id}`);
    }
    res.status(200).json({
      codeStatus: 200,
      data: user
    });
    
  } catch (err) {
    next(err);
  }
});


```


#### Select with Condition

L·∫•y th√¥ng tin c√≥ ƒëi·ªÅu ki·ªán

```js

  const users = User.find({
    role: 'user',
  });

```

Xem th√™m [t·∫°i ƒë√¢y](MongoDB-Mongosee.md)

Xem th√™m v·ªÅ truy v·∫•n v·ªõi [Moongosee](Query-and-Aggregation.md)


